# PRODUCT_SPEC

## 文档目的
定义 Synora 的产品定位、目标用户、问题边界与 MVP 交付范围，作为后续架构与接口设计的上游输入。

## 当前状态
- 状态：v1 Frozen（设计冻结版）
- 设计阶段：产品范围冻结完成
- Discovery 决策：MVP 已拍板为 Registry-only（见 `docs/Discovery_Scope_Decision_One_Pager.md`）

## 上下文输入
- 项目名：Synora
- 类型：AI 驱动的软件操作系统管理器（CLI-first，本地+AI）
- 当前约束：安全优先、默认不执行真实高风险变更、全链路可审计
- 协作模式：你负责产品决策，我负责实现与文档落地

## 预期输出
- 明确 Synora 首版要解决的问题与不解决的问题
- 明确首版目标用户和核心使用场景
- 明确 MVP 功能范围和完成标准
- 为 `docs/ARCHITECTURE.md`、`docs/API_SPEC.md`、`docs/DATA_MODEL.md` 提供稳定输入
- 明确 AI 在“来源推荐/补链”中的能力边界与安全约束
- 明确 AI 管理助手在“分析/建议/修复”中的能力边界与安全约束

## 定位声明（Phase 1 Freeze）
- Synora 定位为：AI 驱动的软件操作系统管理器。
- 该定位作为设计冻结输入，后续仅通过 ADR 变更。

## 终极版本愿景（Phase 1 Freeze）
- 一句话愿景：`Windows 的 Raycast + Homebrew + AI 安全编排层`。
- 愿景拆分：
1. 入口层：全局搜索即操作（统一命令入口，低摩擦执行）。
2. 供给层：公共仓库 + 个人仓库 + `software.yaml`（可贡献、可治理的软件来源体系）。
3. 控制层：AI 管理助手 + 安全门禁 + 审计闭环（高风险可控、过程可追溯）。

## 顶层决策（Phase 1 Freeze）
1. 首版平台范围：仅 Windows（冻结）。
2. 首版交互形态：仅 CLI（冻结，GUI 后置）。
3. 真实变更默认策略：默认关闭（冻结，需显式门禁开启）。
4. 审计导出：属于 MVP（至少 JSON）。
5. 插件开放策略：MVP 仅接口与治理模型，Phase 2 开放官方插件。
6. AI 修复策略：MVP 仅 `repair-plan`，`repair-apply` 后置。
7. 下载边界：MVP 为下载+校验，不直接自动安装。
8. UI 入口策略：全局搜索优先（Raycast 风格主入口）。

## 冻结产品条目（Phase 1 Freeze）
1. 目标用户与场景
- 用户 A：个人开发者（本机环境管理）
- 用户 B：平台/运维工程师（受控执行与审计）
- 用户 C：安全关注团队（证据留存与追踪）

2. 核心问题定义
- 问题 1：系统变更缺少统一、安全、可追溯执行入口
- 问题 2：高风险操作没有稳定门禁（确认、审批、票据）
- 问题 3：历史操作难以结构化检索与复盘
- 问题 4：软件来源链接分散，人工收集成本高且一致性差

3. 核心价值主张
- 价值 1：安全默认（default safe）
- 价值 2：执行可控（gate + approval + ticket）
- 价值 3：审计可查（machine-readable history）
- 价值 4：本地+AI 辅助补链（自动生成候选下载链接，提高发现效率）
- 价值 5：AI 管理助手（自动整理、场景推荐、修复建议）

4. MVP 范围（In Scope）
- 功能 1：配置初始化与门禁状态查看/设置
- 功能 2：cleanup quarantine 的 dry-run 与 confirmed-simulation
- 功能 3：confirmed 路径强制执行票据（execution-ticket）
- 功能 4：审计历史查询（按状态/时间/关键词过滤）
- 功能 5：错误码契约稳定（0/2/3/4/10）
- 功能 6：基于本地环境与 AI 信号生成“软件来源候选链接”
- 功能 7：候选链接进入待确认池，确认后可进入正式来源清单
- 功能 8：软件自动发现（Software Discovery）并自动生成个人软件库
- 功能 9：AI 软件整理分析（如“开发工具是否过多”）
- 功能 10：AI 场景化安装建议（如“视频剪辑工具推荐”）
- 功能 11：AI 修复方案生成（plan-only）
- 功能 12：下载任务管理（start/list/show/retry）
- 功能 13：下载产物校验（哈希/来源，失败阻断后续安装）
- 功能 14：全局搜索入口（Global Search / Command Palette）
- 功能 15：软件仓库系统（公共仓库 + 个人仓库 + AI 补全）

5. 非目标范围（Out of Scope）
- 非目标 1：完整 GUI
- 非目标 2：跨平台全适配（Linux/macOS 先不承诺）
- 非目标 3：自动提权与隐式后台变更
- 非目标 4：无人值守真实破坏性操作
- 非目标 5：AI 自动静默安装软件（无人工确认）
- 非目标 6：MVP 直接开放第三方插件市场
- 非目标 7：MVP 自动执行 AI 修复动作（无 confirm）
- 非目标 8：MVP 多源镜像智能调度与 P2P 下载
- 非目标 9：MVP 完整多页面 GUI 管理台

6. MVP 验收标准（Definition of Done）
- 标准 1：核心命令可稳定运行并返回确定性退出码
- 标准 2：安全门禁生效（缺审批/缺票据/高风险未确认时阻断）
- 标准 3：所有关键路径写入可查询审计记录
- 标准 4：CLI 合约测试与回归 smoke 全通过
- 标准 5：文档（API/数据模型/架构）与实现一致
- 标准 6：AI 补链仅产出候选，不可绕过确认流程直接执行
- 标准 7：每条候选链接具备可追溯元数据（来源/时间/置信度）
- 标准 8：首次运行可自动发现并生成个人软件库（不依赖手工录入）
- 标准 9：AI 分析/建议输出必须包含 reason 与 confidence
- 标准 10：AI 修复默认仅输出方案，不可绕过确认直接执行
- 标准 11：下载任务必须可查询、可重试、可审计
- 标准 12：下载校验失败不得进入安装链路
- 标准 13：全局搜索可触达核心动作（下载/任务/安全/AI）

8. AI 补链能力边界（Frozen）
- 边界 1：AI 仅“推荐与补全”，不直接执行安装/卸载。
- 边界 2：自动补链结果默认进入候选池（pending），需人工确认。
- 边界 3：优先白名单/官方域名；非白名单结果标记为风险候选。
- 边界 4：所有候选记录必须可审计（生成上下文 + 决策结果）。

8.1 AI 管理助手能力边界（Frozen）
- 边界 1：支持三类任务：软件整理分析、场景化安装建议、修复方案建议。
- 边界 2：默认只输出建议或计划，不直接触发真实系统变更。
- 边界 3：所有 AI 输出必须有证据字段：`reason`、`confidence`、`risk_level`。
- 边界 4：涉及安装/修复执行时，必须走 confirm + gate + 审计。

9. 功能分层决策（Frozen）
- A. MVP 必做（核心闭环）
- A1：一键安装/升级/卸载（在门禁约束下执行）
- A2：可更新软件检测（首版可为手动触发或轻量定时）
- A3：下载源基础安全校验（签名/来源/白名单）
- A4：软件体检、清理、修复能力的最小安全子集
- A5：软件自动发现并生成个人软件库（Software Discovery）
- A6：下载模块（受控下载 + 校验 + 审计）
- A7：全局搜索（Raycast 风格主入口）
- A8：软件仓库系统 MVP（个人仓库 + 只读公共仓库索引）
- B. Phase 2 后置（增强能力）
- B1：软件展示与搜索增强（分类、筛选、可读性优化）
- B2：软件来源推荐能力增强（排序、解释信息更完整）
- B3：插件系统（官方插件）扩展来源、更新策略与 AI 工具
- B4：AI 修复执行（受控执行模式，默认关闭）
- B5：下载增强（多源镜像、断点续传优化、调度策略）
- B6：完整 GUI 信息架构与多视图面板
- B7：社区仓库贡献流程（software.yaml 提交与审核）
- C. 暂不做（当前阶段不投入）
- C1：重运营化的软件榜单体系
- C2：面向消费分发的评分生态

10. 软件自动发现模块（Software Discovery，Frozen）
- 目标：自动扫描本机已安装软件，生成个人软件库（inventory），作为后续更新检测、AI 补链与治理能力的数据底座。
- 扫描来源优先级：
- P0（MVP 已拍板）：Windows Registry 卸载清单
- `HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall`
- `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall`
- P1（Phase 2 候选）：`Program Files` / Start Menu 快捷方式索引
- P2（Phase 2 候选）：Portable Apps 目录规则扫描
- 首版输出（最小字段）：
- `name`
- `version`（可空）
- `publisher`（可空）
- `install_location`（可空）
- `discovery_source`（registry/program_files/start_menu/portable）
- `confidence`（0-100）
- `first_seen_at`
- `last_seen_at`
- 边界约束：
- 仅做“发现+入库”，不触发自动卸载/自动修复等高风险动作。
- 发现结果允许冲突与重复候选，由后续归并策略处理（在架构设计阶段细化）。

11. 插件系统（Plugin System，Frozen）
- 目标：通过插件扩展软件源、更新规则、AI 工具与系统工具，避免核心系统频繁改动。
- 插件类型：
- `source_provider`：GitHub、Steam、JetBrains、Python、Node 等来源能力
- `update_policy`：更新风控与企业策略扩展
- `ai_tool`：推荐、解释、补链策略扩展
- `system_tool`：体检、清理、修复工具扩展
- 首版策略：
- MVP：只定义插件接口与审计约束，不开放第三方安装
- Phase 2：开放官方插件包
- Phase 3：评估 Rust WASM 插件沙箱
- 安全边界：
- 插件能力不能绕过 gate 与审批记录
- 插件执行必须写入审计记录
- 高风险操作仍需显式 confirm

12. AI 管理助手（Frozen）
- A. 软件自动整理（Analyze）
- 输入：本机软件库与更新信号
- 输出：分类统计、冗余/重复工具提示、建议保留/清理项
- B. 场景化安装建议（Recommend）
- 输入：用户任务目标（如视频剪辑）
- 输出：推荐软件集合、候选来源、推荐理由与风险提示
- C. 自动修复方案（Repair Plan）
- 输入：问题描述（如 Chrome 崩溃）+ 本地状态
- 输出：分步修复计划（清缓存/重装/插件排查）与回滚建议
- D. 执行边界
- MVP：仅 `repair-plan`
- Phase 2：评估 `repair-apply`（受控执行）

13. 下载模块（Download Module，Frozen）
- 目标：提供受控下载与基础校验能力，为安装/升级链路提供可信产物。
- MVP 能力：
- `download start/list/show/retry`
- 哈希校验（SHA256）
- 来源白名单校验（域名级）
- 任务全链路审计
- 执行边界：
- 下载模块仅负责“获取与校验”，不直接执行安装。
- 校验失败必须阻断后续安装流程。

14. 全局搜索 UI 模块（Frozen）
- 目标：提供“一个入口到全部能力”的交互体验（类似 Raycast）。
- 核心能力：
- 全局命令检索（动作、软件、任务、安全、AI 建议）
- 结果分组展示与快捷执行
- 高风险动作统一确认拦截
- 执行反馈与错误恢复入口
- 与后端耦合边界：
- UI 只调用 API，不直接触达 Worker/DB。
- 执行动作仍走 queue + worker + security + audit 链路。
15. 软件仓库系统（Frozen）
- 目标：建立“公共仓库 + 个人仓库 + AI”三层来源体系，支持社区贡献与本地治理并存。
- 对标能力：
- 公共仓库：类似 winget/brew taps 的可检索目录
- 个人仓库：用户本地私有来源（自定义软件条目）
- 社区贡献：通过 `software.yaml` 提交候选条目
- MVP 范围：
- 支持仓库注册、同步、检索
- 支持个人仓库条目导入/导出（`software.yaml`）
- 公共仓库先只读消费，不直接开放匿名写入
- AI 边界：
- AI 可辅助生成 `software.yaml` 候选内容（name/version/install/check_update 等）
- 生成结果默认进入待审状态，不直接发布到公共仓库
- Phase 2 扩展：
- 社区提交流程（提交/审核/拒绝/发布）
- 包元数据质量评分与冲突检测
7. 成功指标（MVP）
- 指标 1：关键命令成功率与预期退出码一致率 >= 99%
- 指标 2：高风险误执行次数 = 0
- 指标 3：审计查询覆盖率（关键操作均可检索）= 100%

## 更新规则
- 若 MVP 边界变化，必须同步更新：
  - `docs/FEATURES.md`
  - `docs/ROADMAP.md`
  - `docs/API_SPEC.md`
  - `logs/DEVELOPMENT_LOG.md`
- 本文档优先级高于实现细节文档；实现应服从产品范围约束。
